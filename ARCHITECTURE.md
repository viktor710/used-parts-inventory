# Архитектура системы учета б/у запчастей

## Обзор системы

Система представляет собой веб-приложение для учета и управления б/у автомобильными запчастями, построенное на Next.js 14 с использованием App Router, TypeScript и PostgreSQL.

## Технологический стек

### Основные технологии
- **Next.js 14** - React фреймворк с App Router
- **TypeScript** - типизированный JavaScript
- **PostgreSQL** - реляционная база данных
- **Prisma** - ORM для работы с базой данных
- **NextAuth.js** - аутентификация и авторизация
- **Tailwind CSS** - CSS фреймворк для стилизации

### Дополнительные библиотеки
- **Cloudinary** - облачное хранение изображений
- **Winston** - логирование
- **Zod** - валидация данных
- **Lucide React** - иконки
- **Sharp** - обработка изображений

### Интеграции с внешними API
- **Context7** - доступ к документации библиотек
- **Cloudinary** - управление изображениями
- **Supabase** - альтернативная база данных
- **Vercel** - хостинг и деплой

## Архитектурные слои

### 1. Презентационный слой (Presentation Layer)
```
app/
├── layout.tsx          # Корневой layout
├── page.tsx           # Главная страница
├── cars/              # Страницы автомобилей
├── parts/             # Страницы запчастей
├── customers/         # Страницы клиентов
├── suppliers/         # Страницы поставщиков
├── sales/             # Страницы продаж
├── reports/           # Отчеты
├── settings/          # Настройки
└── auth/              # Аутентификация
```

**Компоненты:**
- `components/ui/` - переиспользуемые UI компоненты
- `components/layout/` - компоненты макета
- `components/providers/` - провайдеры контекста

### 2. Слой API (API Layer)
```
app/api/
├── auth/              # NextAuth API роуты
├── cars/              # API для автомобилей
├── parts/             # API для запчастей
├── customers/         # API для клиентов
├── suppliers/         # API для поставщиков
├── sales/             # API для продаж
├── stats/             # API статистики
├── upload/            # API загрузки файлов
└── zapchasti/         # API для работы с запчастями
```

### 3. Слой бизнес-логики (Business Logic Layer)
```
lib/
├── prisma.ts          # Конфигурация Prisma
├── auth.ts            # Логика аутентификации
├── cars.ts            # Бизнес-логика автомобилей
├── parts.ts           # Бизнес-логика запчастей
├── stats.ts           # Бизнес-логика статистики
├── cloudinary.ts      # Интеграция с Cloudinary
├── logger.ts          # Система логирования
└── validation.ts      # Валидация данных
```

### 4. Слой данных (Data Layer)
```
prisma/
├── schema.prisma      # Схема базы данных
└── migrations/        # Миграции базы данных
```

## Взаимодействие модулей

### Поток данных

1. **Запрос пользователя** → `middleware.ts` (проверка прав)
2. **API Route** → `lib/` (бизнес-логика)
3. **Prisma** → PostgreSQL (данные)
4. **Ответ** → Пользователь

### Схема взаимодействия

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Frontend      │    │   API Routes    │    │   Business      │
│   (React)       │◄──►│   (Next.js)     │◄──►│   Logic         │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                       │
                                ▼                       ▼
                       ┌─────────────────┐    ┌─────────────────┐
                       │   Middleware    │    │   Database      │
                       │   (Auth/RBAC)   │    │   (Prisma)      │
                       └─────────────────┘    └─────────────────┘
```

### Детальное взаимодействие

#### Аутентификация и авторизация
```
User Request → middleware.ts → NextAuth → lib/auth.ts → Database
```

#### CRUD операции
```
User Action → API Route → lib/[entity].ts → Prisma → PostgreSQL
```

#### Загрузка файлов
```
File Upload → API Route → lib/cloudinary.ts → Cloudinary → Database
```

#### Интеграция с внешними API
```
External Request → lib/[service].ts → External API → Response Processing
```

## Ключевые зависимости

### Внешние сервисы

#### 1. PostgreSQL (База данных)
- **Назначение**: Основное хранилище данных
- **Конфигурация**: Через переменную окружения `DATABASE_URL`
- **ORM**: Prisma для типизированного доступа к данным

#### 2. Cloudinary (Облачное хранилище)
- **Назначение**: Хранение и обработка изображений
- **Интеграция**: `lib/cloudinary.ts`
- **Использование**: Загрузка изображений автомобилей и запчастей

#### 3. NextAuth.js (Аутентификация)
- **Назначение**: Управление сессиями и аутентификацией
- **Конфигурация**: `app/api/auth/[...nextauth]/route.ts`
- **Адаптер**: Prisma Adapter для хранения сессий в БД

#### 4. Context7 (Документация библиотек)
- **Назначение**: Доступ к актуальной документации используемых библиотек
- **Использование**: Изучение API и интеграция новых библиотек
- **Обязательно**: Перед интеграцией любой новой библиотеки

### Внутренние зависимости

#### 1. Prisma ORM
```typescript
// lib/prisma.ts
export const prisma = new PrismaClient({
  log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],
})
```

#### 2. Система логирования
```typescript
// lib/logger.ts
import winston from 'winston';
```

#### 3. Валидация данных
```typescript
// lib/validation.ts
import { z } from 'zod';
```

## Модели данных

### Основные сущности

#### User (Пользователи)
- Аутентификация и авторизация
- Роли: ADMIN, MANAGER, USER

#### Car (Автомобили)
- Информация об автомобилях
- Связь с запчастями (one-to-many)

#### Part (Запчасти)
- Информация о запчастях
- Связи с автомобилями и продажами

#### Customer (Клиенты)
- Информация о клиентах
- Связь с продажами

#### Supplier (Поставщики)
- Информация о поставщиках

#### Sale (Продажи)
- Информация о продажах
- Связи с запчастями и клиентами

## Безопасность

### Аутентификация
- NextAuth.js с JWT токенами
- Хеширование паролей (bcryptjs с cost factor 12+)
- Защищенные API роуты

### Авторизация
- Ролевая модель (RBAC)
- Проверка прав в middleware
- Иерархия ролей: USER < MANAGER < ADMIN

### Валидация
- Zod схемы для валидации данных
- Санитизация входных данных
- Защита от SQL-инъекций (Prisma)

### Дополнительная защита
- Rate limiting для API
- CORS настройки
- Защита от XSS и CSRF атак
- Аудит действий пользователей

## Производительность

### Оптимизации
- Server Components в Next.js 14
- Оптимизация изображений (Sharp)
- Индексы в базе данных
- Кэширование на уровне приложения

### Мониторинг
- Winston логирование
- Отладочная информация в development
- Метрики производительности
- Алерты при превышении порогов

### Целевые показатели
- Время ответа API: < 200ms
- Время загрузки страниц: < 2s
- Lighthouse score: > 90
- Покрытие тестами: > 80%

## Развертывание

### Переменные окружения
```env
DATABASE_URL=postgresql://...
DIRECT_URL=postgresql://...
NEXTAUTH_SECRET=...
NEXTAUTH_URL=...
CLOUDINARY_URL=...
```

### Скрипты
- `npm run dev` - разработка
- `npm run build` - сборка
- `npm run start` - продакшн
- `npm run db:migrate` - миграции БД

## Структура проекта

```
Sait/
├── app/               # Next.js App Router
├── components/        # React компоненты
├── lib/              # Бизнес-логика и утилиты
├── prisma/           # Схема и миграции БД
├── types/            # TypeScript типы
├── utils/            # Вспомогательные функции
├── hooks/            # React хуки
├── scripts/          # Скрипты для БД
└── docs/             # Документация
```

## Документирование кода

### JSDoc комментарии с @tags
Система использует структурированное документирование с JSDoc тегами для лучшего понимания контекста Cursor:

#### Обязательные теги для функций
```typescript
/**
 * @description Создает новый автомобиль в базе данных
 * @param {CarData} carData - Данные автомобиля для создания
 * @param {PrismaClient} prisma - Экземпляр Prisma клиента
 * @returns {Promise<Car>} Созданный автомобиль
 * @throws {ValidationError} При ошибке валидации данных
 * @throws {DatabaseError} При ошибке базы данных
 */
export async function createCar(carData: CarData, prisma: PrismaClient): Promise<Car>
```

#### Теги для React компонентов
```typescript
/**
 * @component CarCard
 * @description Карточка для отображения информации об автомобиле
 * @param {CarCardProps} props - Свойства компонента
 * @returns {JSX.Element} React компонент карточки
 */
export function CarCard({ car, isEditable, onEdit }: CarCardProps): JSX.Element
```

#### Теги для API роутов
```typescript
/**
 * @api POST /api/cars
 * @description Создает новый автомобиль
 * @body {CarCreateData} carData - Данные для создания автомобиля
 * @returns {ApiResponse<Car>} Ответ с созданным автомобилем
 * @throws {400} При ошибке валидации
 * @throws {401} При отсутствии аутентификации
 */
export async function POST(request: Request): Promise<Response>
```

### Связывание контекста
- **@see** теги для связывания связанных функций
- **@example** теги для примеров использования
- **@since** теги для версионности
- **@deprecated** теги для устаревшего кода

## Интеграция с внешними API

### Процесс интеграции
1. **Изучение документации** через Context7
2. **Проверка совместимости** с текущим стеком
3. **Создание плана интеграции** с учетом архитектуры
4. **Реализация интеграции** следуя лучшим практикам
5. **Документирование изменений** в соответствующих файлах
6. **Тестирование интеграции** локально и в staging

### Примеры интеграций
- **Cloudinary**: Управление изображениями
- **Supabase**: Альтернативная база данных
- **Winston**: Структурированное логирование
- **Zod**: Валидация данных
- **NextAuth.js**: Аутентификация

## Рекомендации по развитию

1. **Масштабирование**: Добавить Redis для кэширования
2. **Мониторинг**: Интеграция с Sentry для отслеживания ошибок
3. **Тестирование**: Добавить Jest и React Testing Library
4. **CI/CD**: Настройка автоматического развертывания
5. **API**: Добавить GraphQL для более гибких запросов
6. **Безопасность**: Регулярные аудиты безопасности
7. **Производительность**: Непрерывный мониторинг метрик

---

**Последнее обновление**: Сентябрь 2024
**Версия документа**: 2.0.0
**Соответствует правилам**: .cursor/rules/main.mdc v2.0.0
